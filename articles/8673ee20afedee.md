---
title: "Git過去改変ことはじめ【初心者向け】"
emoji: "🐦"
type: "tech"
topics: [Git]
published: false
---

## はじめに
Gitの過去を改変する、かんたんなトピックをまとめていきます。
n番煎じですが、私自身が普段よく使用するコマンドたちを紹介します。いつもお世話になっております。

:::message alert
リモートブランチにpush済みのコミットを改変する場合、強制プッシュ`git push -f(/--force-with-lease)`が必要で、コンフリクトが発生します。
仮に該当ブランチを他メンバーがpullしていた場合、そのメンバーに迷惑がかかる恐れがあります。極力push済みのコミットは改変しない方が得策です。
（protectされているブランチはそもそも強制プッシュが不可だったりします。）
:::

## 結論
直前のコミットを改変するには、`git commit --amend`。
2つ以上前のコミットを改変するには、`git rebase -i`。

## 直前のコミットを改変したい: `git commit --amend`

### トピック①: 直前のコミットのコミットメッセージを変更したい
🐦「あ、コミットメッセージ間違えてコミットしちゃった...」
🐦「あ、コミットメッセージにプレフィックスつけ忘れちゃった...」
など、直前のコミットメッセージを修正したいこと、よくあると思います。
**そんな時は`git commit --amend`です。**

```shell
git commit --amend -m "修正メッセージ"
```

#### 実例

![](/images/8673ee20afedee/2023-05-23-23-46-13.png)
*改変前*

![](/images/8673ee20afedee/2023-05-23-23-48-01.png)


![](/images/8673ee20afedee/2023-05-23-23-47-36.png)
*改変後*

:::details ちなみに
`-m`オプションをつけない場合、エディタモードが展開して直前のコミットメッセージを修正できます。「プレフィクスつけ忘れた」など軽微なメッセージ修正の場合はこちらの方が有用です。

![](/images/8673ee20afedee/2023-05-23-23-51-57.png)
:::


### トピック②: 直前のコミットに混ぜてコミットしたい
🐦「あ、この差分ステージングから漏れてたのにコミットしちゃった...」
など、ある差分を直前のコミットに混ぜてコミットしたいこと、よくあると思います。
**そんな時は`git commit --amend --no-edit`です。**

```shell
git commit --amend --no-edit
```

#### 実例

![](/images/8673ee20afedee/2023-05-24-00-03-50.png)
*改変前（`h1`の差分のみ）*

![](/images/8673ee20afedee/2023-05-24-07-43-28.png)
*混ぜたい差分をステージング & 改変コミット*

![](/images/8673ee20afedee/2023-05-24-00-03-44.png)
*改変後（直前のコミットに`p`の差分も追加されている）*

:::details Gitのエイリアスについて
この直前のコミットに混ぜてコミットするという過去改変、個人的によく使うためエイリアスにコマンドを登録しています。

```shell
git cma
# = git commit --amend --no-edit
```

エイリアスの登録方法はこちらの記事をご参照まで。

https://zenn.dev/tanaka_takeru/articles/b7434259330e11

:::


## 2つ以上前のコミットを改変したい: `git rebase -i`

### トピック③: 2つ以上前のコミットのコミットメッセージを変更したい
🐦「あ、よく考えたらこの4つ前のコミット、メッセージがおかしいな...」
みたいなこと、よくあると思います。
`git commit --amend`で改変できるのは直前のコミットのみなので、2つ以上前のコミットを改変しようとすると大変です。
（コミットを1つ1つ`git reset --soft HEAD^`でリセットして`git stash`で格納し混ぜたいコミットの直前まで移動してから`git commit --amend`、という方法でできなくもないですが、とても面倒です。）

**そんな時は`git rebase -i`です。**
`HEAD~{n}`でnつ前までのコミットを改変できます。

```shell
git rebase -i HEAD~{n}
```

実行するとエディタモードが展開し、nつ前までのコミットをすべて改変することが可能です。（vim操作が必要）

![](/images/8673ee20afedee/2023-05-24-07-56-19.png)
*エディタモード*

エディタモードでは`{command} {commitID} {commit message}`という並びで過去のコミットが羅列されます。ここで`{command}`を指定することでそのコミットに対し任意の操作を行うことができます。
エディタモード上でもすべてのコマンドの説明が載っていますが、今回のように「コミットメッセージを変更したい」という場合は`r (reword)`コマンドを使用します。


#### 実例

![](/images/8673ee20afedee/2023-05-24-07-57-06.png)
*エディタモード展開（5つ前までのコミットを改変可能）*

![](/images/8673ee20afedee/2023-05-24-07-58-44.png)
*メッセージを変更したいコミットへ`r`コマンドを指定*

↓ `:x`で保存してエディタモードを終了

![](/images/8673ee20afedee/2023-05-24-08-02-24.png)
*再びエディタモードが展開。ここでメッセージを修正する*

↓ `:x`で保存してエディタモードを終了

![](/images/8673ee20afedee/2023-05-24-08-03-52.png)
*過去改変完了*

:::details vim操作の便利トピック
単語上にカーソルがある状態で`diw`コマンドを入力すると、その単語を削除できます（厳密にはカットされているため、その後ペーストが可能です）。
- 単語上にカーソルを置き`diw`
- `i`
- メッセージを変更
という操作でスムーズに変更可能です。

![](/images/8673ee20afedee/2023-05-24-08-17-24.png)

↓ `diw`

![](/images/8673ee20afedee/2023-05-24-08-17-41.png)

:::


### トピック④: 2つ以上前のコミットに差分を混ぜたい
🐦「この差分2つ前のコミットと一緒に積むべきだったな...」
🐦「『漏れていたためコミット』ていうコミット積みたくないな...」
など、とある差分を2つ以上前のコミットに混ぜてコミットしたいこと、よくあると思います。
**そんな時は`git rebase -i`の`f (fixup)`コマンドです。**
このコマンドであるコミットを特定のコミットにマージすることが可能です。

#### 実例
「11番目のコミット」を「6番目のコミット」にマージする方法を見ていきます。

![](/images/8673ee20afedee/2023-05-24-08-24-30.png)
*改変前*

![](/images/8673ee20afedee/2023-05-24-08-25-46.png)
*`git rebase -i HEAD~{n}`でエディタモードを展開*

↓ 「11番目のコミット」のコミットIDをヤンクし「6番目のコミット」の1行下に貼り付け、`f`コマンドを指定します。

![](/images/8673ee20afedee/2023-05-24-08-41-07.png)

↓ 「11番目のコミット」の行を削除し、保存して終了

![](/images/8673ee20afedee/2023-05-24-08-31-07.png)

これで完了です。「11番目のコミット」が「6番目のコミット」にマージされました。

![](/images/8673ee20afedee/2023-05-24-08-44-22.png)

:::details その他よく使う`git rebase`のコマンド

**`e (edit)`: コミットの内容を編集する**


**`s (squash)`: 直前のコミットにマージしつつメッセージも変更する**


:::

## おわりに
ここまで私が普段よく使うGitの過去改変をまとめてきました。
`git rebase`の機能も、`git commit`のフラグも、まだまだ